<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebSocket Video Stream Test</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: monospace; background: #111; color: #ccc; padding: 1rem; }
    h1 { font-size: 1.2rem; margin-bottom: 1rem; }
    .controls { display: flex; gap: 0.5rem; margin-bottom: 1rem; align-items: center; }
    button { font-family: monospace; padding: 0.4rem 0.8rem; cursor: pointer;
             background: #333; color: #ccc; border: 1px solid #555; border-radius: 4px; }
    button:hover { background: #444; }
    button:disabled { opacity: 0.4; cursor: default; }
    input { font-family: monospace; padding: 0.4rem; background: #222; color: #ccc;
            border: 1px solid #555; border-radius: 4px; width: 140px; }
    #video { max-width: 100%; border: 1px solid #333; border-radius: 4px; display: block;
             background: #000; image-rendering: auto; }
    .stats { margin-top: 0.75rem; font-size: 0.85rem; line-height: 1.6; }
    .stats span { color: #0f0; }
    .log { margin-top: 1rem; max-height: 150px; overflow-y: auto; font-size: 0.75rem;
           background: #0a0a0a; padding: 0.5rem; border-radius: 4px; border: 1px solid #222; }
    .log div { padding: 1px 0; }
    .log .err { color: #f66; }
    .log .ok { color: #6f6; }
  </style>
</head>
<body>
  <h1>WebSocket Video Stream Test</h1>

  <div class="controls">
    <button id="btnCreate">1. Create feed</button>
    <label>Source: <input id="inputSource" value="0" placeholder="0, 1, rtsp://..." /></label>
    <button id="btnStream" disabled>2. Stream</button>
    <button id="btnStop" disabled>Stop</button>
    <button id="btnDelete" disabled>Delete feed</button>
  </div>

  <img id="video" width="640" height="480" alt="stream" />

  <div class="stats">
    Feed ID: <span id="feedId">—</span><br>
    Status: <span id="status">disconnected</span><br>
    Frames received: <span id="frameCount">0</span><br>
    FPS (actual): <span id="fps">0</span><br>
    Avg frame size: <span id="frameSize">0</span> KB<br>
    Latency (frame→render): <span id="latency">0</span> ms
  </div>

  <div class="log" id="log"></div>

  <script>
    // Use relative URLs so Vite's dev proxy handles CORS
    const API = "";
    const WS_URL = `${location.protocol === "https:" ? "wss:" : "ws:"}//${location.host}/ws/video`;

    const video = document.getElementById("video");
    const elFeedId = document.getElementById("feedId");
    const elStatus = document.getElementById("status");
    const elFrameCount = document.getElementById("frameCount");
    const elFps = document.getElementById("fps");
    const elFrameSize = document.getElementById("frameSize");
    const elLatency = document.getElementById("latency");
    const logEl = document.getElementById("log");

    let feedId = null;
    let ws = null;
    let frameCount = 0;
    let totalBytes = 0;
    let fpsFrames = 0;
    let fpsInterval = null;
    let lastFrameTime = 0;

    function log(msg, cls = "") {
      const d = document.createElement("div");
      d.className = cls;
      d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logEl.prepend(d);
      if (logEl.children.length > 200) logEl.lastChild.remove();
    }

    // 1. Create feed
    document.getElementById("btnCreate").onclick = async () => {
      const source = document.getElementById("inputSource").value.trim() || "0";
      log(`Creating camera feed with source="${source}"...`);
      try {
        const res = await fetch(`${API}/api/feeds`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ feed_type: "camera", source, name: `test-${source}` }),
        });
        if (!res.ok) {
          const err = await res.json();
          log(`Create failed: ${err.error || res.status}`, "err");
          return;
        }
        const data = await res.json();
        feedId = data.feed_id;
        elFeedId.textContent = feedId;
        elStatus.textContent = data.status;
        log(`Feed created: ${feedId} (${data.status})`, "ok");
        document.getElementById("btnStream").disabled = false;
        document.getElementById("btnDelete").disabled = false;
      } catch (e) {
        log(`Network error: ${e.message}`, "err");
      }
    };

    // 2. Start streaming
    document.getElementById("btnStream").onclick = () => {
      if (!feedId) return;
      log(`Connecting WebSocket to ${WS_URL}...`);
      ws = new WebSocket(WS_URL);

      ws.onopen = () => {
        elStatus.textContent = "connected";
        log("WebSocket open, subscribing...", "ok");
        ws.send(JSON.stringify({ action: "subscribe", feed_id: feedId }));
        startFpsCounter();
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        if (msg.type === "subscribed") {
          elStatus.textContent = "streaming";
          log(`Subscribed to ${msg.feed_id}`, "ok");
          document.getElementById("btnStop").disabled = false;
          document.getElementById("btnStream").disabled = true;
          return;
        }

        if (msg.type === "frame") {
          const now = performance.now();
          frameCount++;
          fpsFrames++;

          // Approximate payload size (base64 string length * 0.75 for decoded bytes)
          const bytes = msg.data.length * 0.75;
          totalBytes += bytes;

          video.src = `data:image/jpeg;base64,${msg.data}`;

          elFrameCount.textContent = frameCount;
          elFrameSize.textContent = (totalBytes / frameCount / 1024).toFixed(1);

          if (lastFrameTime > 0) {
            elLatency.textContent = (now - lastFrameTime).toFixed(1);
          }
          lastFrameTime = now;
        }
      };

      ws.onclose = () => {
        elStatus.textContent = "disconnected";
        log("WebSocket closed");
        stopFpsCounter();
        document.getElementById("btnStop").disabled = true;
        document.getElementById("btnStream").disabled = false;
      };

      ws.onerror = () => {
        log("WebSocket error", "err");
      };
    };

    // Stop streaming
    document.getElementById("btnStop").onclick = () => {
      if (ws) {
        ws.send(JSON.stringify({ action: "unsubscribe" }));
        ws.close();
        ws = null;
      }
      elStatus.textContent = "stopped";
      stopFpsCounter();
      document.getElementById("btnStop").disabled = true;
      document.getElementById("btnStream").disabled = false;
    };

    // Delete feed
    document.getElementById("btnDelete").onclick = async () => {
      if (!feedId) return;
      if (ws) {
        ws.close();
        ws = null;
      }
      await fetch(`${API}/api/feeds/${feedId}`, { method: "DELETE" });
      log(`Feed ${feedId} deleted`, "ok");
      feedId = null;
      elFeedId.textContent = "—";
      elStatus.textContent = "disconnected";
      document.getElementById("btnStream").disabled = true;
      document.getElementById("btnDelete").disabled = true;
      document.getElementById("btnStop").disabled = true;
      stopFpsCounter();
    };

    // FPS counter — updates every second
    function startFpsCounter() {
      fpsFrames = 0;
      fpsInterval = setInterval(() => {
        elFps.textContent = fpsFrames;
        fpsFrames = 0;
      }, 1000);
    }

    function stopFpsCounter() {
      clearInterval(fpsInterval);
      fpsInterval = null;
      elFps.textContent = "0";
    }
  </script>
</body>
</html>
