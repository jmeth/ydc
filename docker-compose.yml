# YOLO Dataset Creator — Docker Compose
#
# Usage:
#   docker compose up              # frontend (port 80) + backend
#   docker compose --profile legacy up  # also starts legacy Flask server (port 5001)
#
# GPU support (requires nvidia-container-toolkit):
#   docker compose -f docker-compose.yml -f docker-compose.gpu.yml up

services:
  # Vue SPA served by nginx, reverse-proxies /api and /ws to backend
  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    # Security
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # nginx needs to bind port 80
    security_opt:
      - no-new-privileges:true

  # FastAPI backend — not exposed externally, reached via nginx proxy
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    volumes:
      - ydc-datasets:/app/datasets
      - ydc-models:/app/models
      - ydc-runs:/app/runs
    environment:
      - YDC_CORS_ORIGINS=["http://localhost"]
    restart: unless-stopped
    # Security
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:noexec,nosuid,nodev

  # Legacy Flask server (only starts with --profile legacy)
  legacy:
    build: .
    ports:
      - "5001:5001"
    volumes:
      - ydc-datasets:/app/datasets
    restart: unless-stopped
    profiles:
      - legacy
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,nodev

volumes:
  ydc-datasets:
  ydc-models:
  ydc-runs:
